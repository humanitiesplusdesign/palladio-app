angular.module("palladioTableComponent",["palladio","palladio.services"]).run(["componentService",function(t){var n=function(t,n){t.showSettings=void 0!==t.showSettings&&t.showSettings,t.tableHeight=void 0===t.height?void 0:t.height,t.maxDisplay=void 0===t.maxDisplay?1/0:t.maxDisplay,t.functions={};var e='<div class="with-settings" data-palladio-table-view-with-settings ';return e+='show-settings="showSettings" ',e+='max-display="maxDisplay" ',e+="functions=functions ",e+='table-height="tableHeight" ',t.dimensions&&(e+='config-dimensions="dimensions" '),t.row&&(e+='config-row="row" '),e+="></div>"};t.register("table",n)}]).directive("palladioTableView",["palladioService",function(t){return{scope:{dimensions:"=",dimension:"=",maxDisplay:"=",tableHeight:"=",xfilter:"=",exportFunc:"="},link:function(n,e,i){function o(){n.tableHeight?n.calcHeight=n.tableHeight:n.calcHeight=$(window).height(),e.height(n.calcHeight),$(e[0].nextElementSibling).height(n.calcHeight)}function a(){if(n.dimension&&l&&0!==v.length){c||(c=v[0].key),r=d3.select(e[0]).select("table"),r.empty()&&(r=d3.select(e[0]).append("table").attr("class","table table-striped"),r.append("thead").append("tr"),r.append("tbody")),d=r.select("tr").selectAll("th").data(v,function(t){return t.key}),d.exit().remove(),d.enter().append("th").text(function(t,n){return t.key+" "}).style("cursor","pointer").on("click",function(t){m=c==t.key?!m:m,c=t.key,p=function(t,n){return m?t[c]<n[c]?1:-1:t[c]<n[c]?-1:1},a()}).append("i").style("margin-left","5px"),d.order();var t=[],i=d3.nest().key(l.accessor).rollup(function(n){return v.map(function(e){return t=[],n.forEach(function(n){t.indexOf(n[e.key])===-1&&n[e.key]&&t.push(n[e.key])}),{key:e.key,values:t}}).reduce(function(t,n){return t[n.key]=n.values.join(", "),t},{})}).entries(l.top(1/0)).map(function(t){return t.values[n.dimension.key]=t.key,t.values}),o=i.filter(function(t){return!g||v.map(function(n){return t[n.key]}).join().toUpperCase().indexOf(g.toUpperCase())!==-1}).sort(p),s=o.slice(0,n.maxDisplay);d3.select(d[0][0]).text(function(t){return t.key+" ("+s.length+" of "+o.length+" rows displayed) "}).append("i").style("margin-left","5px"),d.select("i").attr("class",function(){return m?"fa fa-sort-asc":"fa fa-sort-desc"}).style("opacity",function(t){return t.key==c?1:0}),d.order(),u=r.select("tbody").selectAll("tr").data(s,function(t){return v.map(function(n){return t[n.key]}).join()+l.accessor(t)}),u.exit().remove(),u.enter().append("tr"),u.order(),f=u.selectAll("td").data(function(t){return v.map(function(n){return{key:n.key,value:t[n.key]}})},function(t){return t.key}),f.exit().remove(),f.enter().append("td"),f.html(function(t){return 0===t.value.indexOf("https://")||0===t.value.indexOf("http://")||0===t.value.indexOf("www.")?"<a target='_blank' href='"+t.value+"'>"+t.value+"</a>":t.value}),f.order()}}function s(){n.dimension&&(v=[n.dimension].concat(n.dimensions))}$(document).ready(o),$(window).resize(o);var l,c,r,d,u,f,p=function(){},m=!0,g="",v=[];n.exportFunc=function(){function t(){return window.Blob||window.WebKitBlob||window.MozBlob}var n=d3.csv.format(f.map(function(t){var n={};return t.forEach(function(t){n[t.__data__.key]=t.__data__.value}),n})),e="Palladio table export.csv",i=t(),o=navigator.userAgent.indexOf("Safari")!=-1&&navigator.userAgent.indexOf("Chrome")==-1;if(o){var a="data:text/csv,"+n;window.open(a,"download")}else{var s=new i([n],{type:"data:text/csv"});saveAs(s,e)}};var h="tableView"+Math.floor(1e4*Math.random()),y=[];y.push(t.onUpdate(h,function(){e.is(":visible")&&a()})),n.$watch(function(){return e.is(":visible")},a),n.$watchCollection("dimensions",function(){s(),a()}),n.$watch("dimension",function(){s(),n.dimension&&(l&&l.remove(),l=n.xfilter.dimension(function(t){return""+t[n.dimension.key]}),l.accessor=function(t){return""+t[n.dimension.key]}),a()}),n.$on("$destroy",function(){l&&l.remove(),y.forEach(function(t){t()})}),y.push(t.onSearch(h,function(t){g=t,a()}))}}}]).directive("palladioTableViewWithSettings",["palladioService","dataService",function(t,n){return{scope:{tableHeight:"=",showSettings:"=",maxDisplay:"=",configDimensions:"=",configRow:"=",functions:"="},templateUrl:"partials/palladio-table-component/template.html",link:{pre:function(e,i,o){function a(t){e.$apply(function(n){e.tableDimensions=t.tableDimensions.map(function(t){return n.fields.filter(function(n){return n.key===t.key})[0]}),e.countDim=t.countDim?n.fields.filter(function(n){return n.key===t.countDim.key})[0]:null,e.maxDisplay=void 0===t.maxDisplay?1/0:t.maxDisplay,e.setInternalState(t)})}function s(){return e.readInternalState({tableDimensions:e.tableDimensions.map(function(t){return{key:t.key}}),countDim:e.countDim?{key:e.countDim.key}:null,maxDisplay:e.maxDisplay})}var l=[];e.metadata=n.getDataSync().metadata,e.xfilter=n.getDataSync().xfilter,e.uniqueToggleId="tableView"+Math.floor(1e4*Math.random()),e.uniqueModalId=e.uniqueToggleId+"modal",e.fields=e.metadata.sort(function(t,n){return t.description<n.description?-1:1}),e.tableDimensions=[],e.countDims=e.metadata.sort(function(t,n){return t.description<n.description?-1:1}),e.countDim=null,e.configRow&&(e.countDim=e.countDims.filter(function(t){return t.key===e.configRow.key})[0]),e.configDimensions&&(e.configDimensions.forEach(function(t){e.tableDimensions.push(e.fields.filter(function(n){return n.key===t.key})[0])}),e.fields=e.fields.sort(function(t,n){return e.tableDimensions.indexOf(t)<e.tableDimensions.indexOf(n)?-1:1})),e.getCountDescription=function(t){return t.description},e.showCountModal=function(){$("#"+e.uniqueModalId).find("#count-modal").modal("show")},e.showModal=function(){$("#table-modal").modal("show")},e.fieldDescriptions=function(){return e.tableDimensions.map(function(t){return t.description}).join(", ")},e.setInternalState=function(t){return t},e.readInternalState=function(t){return t},e.exportCsv=function(){},e.functions&&(e.functions.getSettings=function(){return i.find(".table-settings")[0]},e.functions.importState=function(t){return a(t),!0},e.functions.exportState=function(){return s()}),l.push(t.registerStateFunctions(e.uniqueToggleId,"tableView",s,a)),e.$on("$destroy",function(){l.forEach(function(t){t()})})},post:function(t,n,e){n.find(".settings-toggle").click(function(){n.find(".settings").toggleClass("closed")})}}}}]),angular.module("palladio").run(["$templateCache",function(t){t.put("partials/palladio-table-component/template.html",'<div class="">\n\n\t\t<div data-ng-show="countDim"\n\t\t\tdata-palladio-table-view\n\t\t\tdimension="countDim"\n\t\t\ttable-height="tableHeight"\n\t\t\tdimensions="tableDimensions"\n      max-display="maxDisplay"\n\t\t\txfilter="xfilter"\n\t\t\texport-func="exportCsv">\n\t\t</div>\n\n</div>\n\n<!-- Settings -->\n<div class="row table-settings" data-ng-show="showSettings || showSettings === undefined">\n\n    <div class="settings col-lg-4 col-lg-offset-8 col-md-6 col-md-offset-6">\n      <div class="panel panel-default">\n\n        <a class="settings-toggle" data-toggle="tooltip" data-original-title="Settings" data-placement="bottom">\n          <i class="fa fa-bars"></i>\n        </a>\n\n        <div class="panel-body">\n\n          <div class="row">\n            <div class="col-lg-12">\n              <label>Settings</label>\n            </div>\n          </div>\n\n          <div class="row margin-top">\n            <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 text-right">\n              <label class="inline">Row dimension</label>\n            </div>\n            <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8 col-condensed">\n              <span class="btn btn-default" ng-click="showCountModal()">\n                  {{countDim.description || "Choose"}}\n                  <span class="caret"></span>\n              </span>\n\t\t\t\t\t\t\t<p class="help-block">At least one row per value in this dimension. Multiple values will be displayed as lists in each cell.</p>\n\n            </div>\n          </div>\n\n          <div class="row margin-top">\n            <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 text-right">\n              <label class="inline">Dimensions</label>\n            </div>\n            <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8 col-condensed">\n\t\t\t\t\t\t\t<span class="btn btn-default" ng-click="showModal()">\n                  {{fieldDescriptions() || "Choose"}}\n                  <span class="caret"></span>\n              </span>\n            </div>\n          </div>\n\n\t\t\t\t\t<div class="row margin-top">\n            <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 text-right">\n            </div>\n            <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8 col-condensed">\n\n              <a class="pull-right"\n\t\t\t\t\t\t\ttooltip="Download data (csv)"\n\t\t\t\t\t\t\ttooltip-animation="false"\n\t\t\t\t\t\t\ttooltip-append-to-body="true"\n\t\t\t\t\t\t\tng-click="exportCsv()">\n\t\t\t\t\t\t\t\t<i class="fa fa-download margin-right"></i>Download\n\t\t\t\t\t\t\t</a>\n\n            </div>\n          </div>\n\n\n        </div>\n      </div>\n    </div>\n\n</div>\n\n<div id="{{uniqueModalId}}">\n\t<div id="table-modal" data-modal description="Choose data dimensions" dimensions="fields" model="tableDimensions" sortable="true"></div>\n\t<div id="count-modal" data-modal description="Choose key dimension (one row for each value of this dimension)" dimensions="countDims" model="countDim" description-accessor="getCountDescription"></div>\n</div>\n')}]);